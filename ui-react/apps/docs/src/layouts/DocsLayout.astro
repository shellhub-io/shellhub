---
import "../styles/global.css";
import { sidebar, flattenItems } from "../data/sidebar";

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;

const defaultCollapsed = new Set<string>();

const rawPath = Astro.url.pathname.replace(/\/$/, "");
const currentPath = rawPath.startsWith("/v2/docs") ? rawPath : `/v2/docs${rawPath}`;

const currentSection = sidebar.find(s =>
  flattenItems(s.items).some(i => i.href.replace(/\/$/, "") === currentPath)
);

const allPages = sidebar.flatMap(s => flattenItems(s.items));
const currentIndex = allPages.findIndex(p => p.href.replace(/\/$/, "") === currentPath);
const prevPage = currentIndex > 0 ? allPages[currentIndex - 1] : null;
const nextPage = currentIndex < allPages.length - 1 ? allPages[currentIndex + 1] : null;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} - ShellHub Docs</title>
    {description && <meta name="description" content={description} />}
    <link rel="icon" type="image/x-icon" href="/v2/docs/favicon.ico" />
  </head>
  <body class="bg-background text-text-primary font-sans antialiased">
    <!-- Header -->
    <header class="sticky top-0 z-50 h-14 bg-background/40 backdrop-blur-xl border-b border-border shadow-lg shadow-black/10">
      <div class="flex items-center justify-between h-full max-w-7xl mx-auto px-8">
        <div class="flex items-center gap-3">
          <a href="/v2/" class="flex items-center shrink-0">
            <img src="/v2/docs/logo-inverted.png" alt="ShellHub" class="h-9" />
          </a>
          <a href="/v2/docs/" class="font-mono text-[10px] font-semibold uppercase tracking-widest text-primary bg-primary-50 border border-primary-100 rounded px-2 py-0.5 no-underline hover:bg-primary-100 transition-colors">
            Docs
          </a>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="cmd-trigger"
            title="Search docs (Ctrl+K)"
            class="flex items-center gap-2 px-3 py-1.5 bg-white/[0.03] border border-border rounded-lg text-text-muted cursor-pointer transition-all hover:bg-white/[0.06] hover:border-border-light hover:text-text-secondary"
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
            <span class="text-[13px]">Search</span>
            <kbd class="font-mono text-[10px] text-text-muted bg-white/[0.04] border border-border rounded px-1.5 py-px">&#8984;K</kbd>
          </button>
          <a href="https://github.com/shellhub-io/shellhub" target="_blank" rel="noopener noreferrer" class="text-text-muted hover:text-text-secondary transition-colors flex items-center">
            <svg viewBox="0 0 24 24" class="w-[18px] h-[18px] fill-current"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
          </a>
        </div>
      </div>
    </header>

    <!-- Body: Sidebar + Content + TOC -->
    <div class="relative max-w-7xl mx-auto grid grid-cols-12 gap-8 px-8">
      <div class="docs-grid-bg"></div>

      <!-- Left Sidebar -->
      <aside id="docs-sidebar" class="col-span-3 sticky top-14 h-[calc(100vh-56px)] overflow-y-auto pt-8 pb-12 hidden md:block">
        <nav class="flex flex-col gap-4">
          {sidebar.map((section) => {
            const sectionId = section.label.toLowerCase().replace(/\s+/g, "-");
            const sectionHasActive = flattenItems(section.items).some(i => i.href.replace(/\/$/, "") === currentPath);
            const isCollapsed = sectionHasActive ? false : defaultCollapsed.has(section.label);
            return (
            <div>
              <button
                class="group flex items-center justify-between w-full text-[11px] font-semibold uppercase tracking-[0.06em] text-text-muted cursor-pointer transition-colors duration-150 hover:text-text-secondary mb-1 aria-expanded:mb-3"
                data-section={sectionId}
                aria-expanded={isCollapsed ? "false" : "true"}
              >
                <span class="flex items-center gap-2">
                  <span class:list={["w-5 h-5 flex items-center justify-center rounded shrink-0", sectionHasActive ? "bg-primary-50 border border-primary-100" : "bg-white/[0.03] border border-white/[0.06]"]}>
                    <svg class:list={["w-3 h-3", sectionHasActive ? "text-primary" : "text-text-muted"]} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><Fragment set:html={section.icon} /></svg>
                  </span>
                  {section.label}
                </span>
                <svg class="w-3 h-3 opacity-0 group-hover:opacity-40 transition-[transform,opacity] duration-200 group-aria-expanded:rotate-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
              </button>
              <div class="grid grid-rows-[1fr] transition-[grid-template-rows] duration-[250ms] ease-in-out data-[collapsed=true]:grid-rows-[0fr]" data-section-items={sectionId} data-collapsed={isCollapsed ? "true" : "false"}>
              <ul class="list-none p-0 m-0 overflow-hidden border-l border-white/[0.06]">
                {section.items.map((item) => {
                  if (item.href) {
                    const isActive = currentPath === item.href.replace(/\/$/, "");
                    return (
                      <li>
                        <a
                          href={item.href}
                          class:list={[
                            "block text-[13.5px] no-underline py-[6px] pl-3 -ml-px border-l-2 transition-colors duration-150",
                            isActive
                              ? "text-text-primary font-medium border-primary"
                              : "text-text-secondary hover:text-text-primary border-transparent",
                          ]}
                        >
                          {item.label}
                        </a>
                      </li>
                    );
                  }
                  const groupId = item.label.toLowerCase().replace(/\s+/g, "-");
                  const hasActivePage = item.items.some((child: any) =>
                    currentPath === child.href.replace(/\/$/, "")
                  );
                  return (
                    <li>
                      <button
                        class="group/grp flex items-center justify-between w-full text-[13.5px] text-text-secondary cursor-pointer transition-colors duration-150 hover:text-text-primary py-[6px] pl-3 -ml-px border-l-2 border-transparent"
                        data-group={groupId}
                        aria-expanded={hasActivePage ? "true" : "false"}
                      >
                        <span>{item.label}</span>
                        <svg class="w-3 h-3 opacity-30 shrink-0 transition-transform duration-200 group-aria-expanded/grp:rotate-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                      </button>
                      <ul
                        class="list-none p-0 m-0 overflow-hidden max-h-[500px] opacity-100 transition-[max-height,opacity] duration-200 ease-in-out data-[collapsed=true]:max-h-0 data-[collapsed=true]:opacity-0 border-l border-white/[0.06] ml-3"
                        data-group-items={groupId}
                        data-collapsed={hasActivePage ? "false" : "true"}
                      >
                        {item.items.map((child: any) => {
                          const isActive = currentPath === child.href.replace(/\/$/, "");
                          return (
                            <li>
                              <a
                                href={child.href}
                                class:list={[
                                  "block text-[13px] no-underline py-[5px] pl-3 -ml-px border-l-2 transition-colors duration-150",
                                  isActive
                                    ? "text-text-primary font-medium border-primary"
                                    : "text-text-secondary hover:text-text-primary border-transparent",
                                ]}
                              >
                                {child.label}
                              </a>
                            </li>
                          );
                        })}
                      </ul>
                    </li>
                  );
                })}
              </ul>
              </div>
            </div>
            );
          })}
        </nav>
      </aside>

      <!-- Content Area -->
      <main class="col-span-12 md:col-span-9 xl:col-span-7 min-w-0 pt-10 pb-20 animate-slide-up" id="docs-scroll">
        <article class="prose">
          <slot />
        </article>

        <!-- Prev / Next -->
        <nav class="flex justify-between mt-14 pt-7 border-t border-border gap-4">
          {prevPage ? (
            <a href={prevPage.href} class="flex flex-col gap-1.5 px-5 py-4 border border-border rounded-xl no-underline transition-all hover:border-primary-300 hover:bg-primary-50">
              <span class="text-xs text-text-muted tracking-wide">&larr; Previous</span>
              <span class="text-[15px] text-primary font-medium">{prevPage.label}</span>
            </a>
          ) : <div />}
          {nextPage && (
            <a href={nextPage.href} class="flex flex-col gap-1.5 px-5 py-4 border border-border rounded-xl no-underline transition-all hover:border-primary-300 hover:bg-primary-50 text-right ml-auto">
              <span class="text-xs text-text-muted tracking-wide">Next &rarr;</span>
              <span class="text-[15px] text-primary font-medium">{nextPage.label}</span>
            </a>
          )}
        </nav>
      </main>

      <!-- Right TOC -->
      <aside class="col-span-2 sticky top-14 self-start h-[calc(100vh-56px)] overflow-y-auto pt-10 pb-10 hidden xl:block" id="docs-toc">
        <p class="font-mono text-[10px] font-semibold uppercase tracking-wider text-text-muted mb-3.5 pl-3">
          On this page
        </p>
        <div id="docs-toc-links"></div>
      </aside>
    </div>

    <!-- Command Palette -->
    <div class="cmd-palette" id="cmd-palette">
      <div class="cmd-overlay" id="cmd-overlay"></div>
      <div class="cmd-dialog">
        <div class="cmd-input-row">
          <svg class="cmd-search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
          <input type="text" class="cmd-input" id="cmd-input" placeholder="Search documentation..." autocomplete="off" spellcheck="false" />
          <kbd class="cmd-esc">esc</kbd>
        </div>
        <div class="cmd-results" id="cmd-results"></div>
      </div>
    </div>

    <script define:vars={{ sidebar, currentPath }}>
      // Command palette
      function flattenSidebarItems(items, sectionLabel) {
        return items.flatMap(item =>
          item.href
            ? [{ label: item.label, href: item.href, section: sectionLabel }]
            : flattenSidebarItems(item.items, sectionLabel)
        );
      }
      const allItems = sidebar.flatMap(section =>
        flattenSidebarItems(section.items, section.label)
      );

      const palette = document.getElementById("cmd-palette");
      const overlay = document.getElementById("cmd-overlay");
      const input = document.getElementById("cmd-input");
      const results = document.getElementById("cmd-results");
      const trigger = document.getElementById("cmd-trigger");

      let selectedIdx = 0;
      let filtered = allItems;

      function open() {
        palette.classList.add("cmd-open");
        input.value = "";
        selectedIdx = 0;
        render(allItems);
        requestAnimationFrame(() => input.focus());
      }

      function close() { palette.classList.remove("cmd-open"); }

      function render(items) {
        filtered = items;
        let section = "";
        let html = "";
        items.forEach((item, i) => {
          if (item.section !== section) {
            section = item.section;
            html += `<div class="cmd-section">${section}</div>`;
          }
          const sel = i === selectedIdx ? " cmd-item--sel" : "";
          const cur = item.href.replace(/\/$/, "") === currentPath ? " cmd-item--cur" : "";
          html += `<a href="${item.href}" class="cmd-item${sel}${cur}" data-i="${i}">
            <span>${item.label}</span>
            ${cur ? '<span class="cmd-badge">current</span>' : ""}
          </a>`;
        });
        results.innerHTML = html || '<div class="cmd-empty">No results</div>';
        results.querySelector(".cmd-item--sel")?.scrollIntoView({ block: "nearest" });
      }

      function filter(q) {
        q = q.toLowerCase().trim();
        if (!q) return render(allItems);
        selectedIdx = 0;
        render(allItems.filter(it =>
          it.label.toLowerCase().includes(q) ||
          it.section.toLowerCase().includes(q) ||
          it.href.toLowerCase().includes(q)
        ));
      }

      trigger?.addEventListener("click", open);
      overlay?.addEventListener("click", close);

      document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          palette.classList.contains("cmd-open") ? close() : open();
        }
        if (!palette.classList.contains("cmd-open")) return;
        if (e.key === "Escape") { close(); return; }
        if (e.key === "ArrowDown") { e.preventDefault(); selectedIdx = Math.min(selectedIdx + 1, filtered.length - 1); render(filtered); }
        if (e.key === "ArrowUp") { e.preventDefault(); selectedIdx = Math.max(selectedIdx - 1, 0); render(filtered); }
        if (e.key === "Enter" && filtered[selectedIdx]) { e.preventDefault(); window.location.href = filtered[selectedIdx].href; }
      });

      input?.addEventListener("input", (e) => filter(e.target.value));
      results?.addEventListener("mouseover", (e) => {
        const item = e.target.closest(".cmd-item");
        if (item) { selectedIdx = parseInt(item.dataset.i); render(filtered); }
      });

      // Sidebar scroll persistence
      const sidebarEl = document.getElementById("docs-sidebar");
      if (sidebarEl) {
        const saved = sessionStorage.getItem("docs-sidebar-scroll");
        if (saved) {
          sidebarEl.scrollTop = parseInt(saved);
          sessionStorage.removeItem("docs-sidebar-scroll");
        } else {
          const activeLink = sidebarEl.querySelector("a.border-primary");
          if (activeLink) {
            activeLink.scrollIntoView({ block: "center" });
          }
        }
        sidebarEl.querySelectorAll("a").forEach(link => {
          link.addEventListener("click", () => {
            sessionStorage.setItem("docs-sidebar-scroll", String(sidebarEl.scrollTop));
          });
        });
      }

      // Sidebar collapsible sections
      document.querySelectorAll("[data-section]").forEach(btn => {
        const sectionId = btn.getAttribute("data-section");
        const items = document.querySelector(`[data-section-items="${sectionId}"]`);
        if (!items) return;

        btn.addEventListener("click", () => {
          const isCollapsed = items.getAttribute("data-collapsed") === "true";
          items.setAttribute("data-collapsed", isCollapsed ? "false" : "true");
          btn.setAttribute("aria-expanded", isCollapsed ? "true" : "false");
        });
      });

      // Sidebar collapsible groups
      document.querySelectorAll("[data-group]").forEach(btn => {
        const groupId = btn.getAttribute("data-group");
        const items = document.querySelector(`[data-group-items="${groupId}"]`);
        if (!items) return;

        function toggle(collapsed) {
          items.setAttribute("data-collapsed", collapsed ? "true" : "false");
          btn.setAttribute("aria-expanded", collapsed ? "false" : "true");
        }

        btn.addEventListener("click", () => {
          const isCollapsed = items.getAttribute("data-collapsed") === "true";
          toggle(!isCollapsed);
        });
      });

      // Right TOC with scroll spy
      (function buildToc() {
        const prose = document.querySelector(".prose");
        const tocLinks = document.getElementById("docs-toc-links");
        const tocAside = document.getElementById("docs-toc");
        if (!prose || !tocLinks) return;

        const headings = prose.querySelectorAll("h2, h3");
        if (headings.length < 2) { tocAside?.classList.add("hidden"); return; }

        headings.forEach((h, i) => {
          if (!h.id) h.id = `section-${i}`;
          const a = document.createElement("a");
          a.href = `#${h.id}`;
          a.textContent = h.textContent;
          a.className = `toc-link${h.tagName === "H3" ? " toc-link--sub" : ""}`;
          tocLinks.appendChild(a);
        });

        const obs = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              tocLinks.querySelectorAll(".toc-link").forEach(l => l.classList.remove("toc-link--active"));
              tocLinks.querySelector(`[href="#${entry.target.id}"]`)?.classList.add("toc-link--active");
            }
          });
        }, { rootMargin: "-72px 0px -70% 0px" });

        headings.forEach(h => obs.observe(h));
      })();
    </script>
  </body>
</html>
