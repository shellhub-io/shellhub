name: Claude Code Review

on:
  # Automatic review only on PR opened (no synchronize â€” author drives re-review)
  # Using pull_request_target because shellhub is public (fork PRs need secrets)
  pull_request_target:
    types: [opened]
    branches: [master]

  # Manual review via /review command in comments
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  review:
    name: Claude Code Review
    if: |
      (github.event_name == 'pull_request_target' && !github.event.pull_request.draft) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '/review')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '/review'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      # Checkout shellhub at workspace root (claude-code-action needs .git here)
      - name: Checkout shellhub (PR branch)
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Generate cross-repo token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLOUD_DISPATCH_APP_ID }}
          private-key: ${{ secrets.CLOUD_DISPATCH_APP_PRIVATE_KEY }}
          owner: shellhub-io
          repositories: cloud,claude

      - name: Determine cloud branch
        id: cloud-branch
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          if git ls-remote --exit-code --heads \
            https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/shellhub-io/cloud.git \
            "$BRANCH" > /dev/null 2>&1; then
            echo "ref=$BRANCH" >> "$GITHUB_OUTPUT"
          else
            echo "ref=master" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout cloud (context)
        uses: actions/checkout@v6
        with:
          repository: shellhub-io/cloud
          token: ${{ steps.app-token.outputs.token }}
          ref: ${{ steps.cloud-branch.outputs.ref }}
          fetch-depth: 1
          path: cloud

      - name: Checkout claude config
        uses: actions/checkout@v6
        with:
          repository: shellhub-io/claude
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 1
          path: claude

      - name: Setup workspace context
        run: |
          # Link CLAUDE.md and .claude/ from claude repo into shellhub checkout
          ln -sf "$GITHUB_WORKSPACE/claude/.claude" "$GITHUB_WORKSPACE/.claude"
          ln -sf "$GITHUB_WORKSPACE/claude/shellhub/CLAUDE.md" "$GITHUB_WORKSPACE/CLAUDE.md"

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          settings: |
            {
              "env": {
                "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
              }
            }
          prompt: |
            You are the lead reviewer for PR #${{ github.event.pull_request.number || github.event.issue.number }}
            in shellhub-io/shellhub (Community Edition).

            The cloud/ (enterprise) repo is checked out at $GITHUB_WORKSPACE/cloud/ for context.
            Focus the review on the shellhub diff. Use cloud/ only to understand cross-repo impact.

            ## Step 1: Gather context

            1. Get the PR diff:
               gh pr diff ${{ github.event.pull_request.number || github.event.issue.number }}
            2. Get the list of changed files:
               gh pr view ${{ github.event.pull_request.number || github.event.issue.number }} --json files
            3. Fetch ALL existing review comments to avoid duplicating feedback:
               gh api repos/shellhub-io/shellhub/pulls/${{ github.event.pull_request.number || github.event.issue.number }}/comments
               gh api repos/shellhub-io/shellhub/pulls/${{ github.event.pull_request.number || github.event.issue.number }}/reviews

            ## Step 2: Spawn 5 reviewer agents IN PARALLEL

            Launch exactly 5 Task agents in a SINGLE message (so they run in parallel).
            Each agent MUST use model: "opus". Each agent gets:
            - The PR diff (pass it in the prompt)
            - The list of changed files
            - Read access to the full codebase (current directory for shellhub, $GITHUB_WORKSPACE/cloud/ for cloud)

            Agent assignments:
            1. **Code Quality**: Project conventions (CLAUDE.md), dead code, single responsibility, error handling, commit hygiene
            2. **Security**: OWASP Top 10 (injection, XSS, CSRF, SSRF), hardcoded secrets, crypto/rand usage, access control, input validation
            3. **Testing**: Missing tests for new/changed behavior, edge cases, test determinism, untested error paths
            4. **Go/TypeScript Patterns**: Error wrapping (%w), goroutine leaks, context propagation, minimal interfaces, React patterns (no `any`, no unnecessary re-renders, Zustand)
            5. **Architecture & Cross-repo**: If PR changes pkg/, check $GITHUB_WORKSPACE/cloud/ for impact. API contract changes, interface compatibility, breaking changes.

            Each agent must return findings as a structured list:
            - file_path: exact path relative to repo root
            - line_start and line_end: exact line numbers in the NEW file
            - severity: critical | high | medium | low
            - description: what's wrong and why
            - suggestion: corrected code (if applicable), or empty string

            Agents must NOT post any GitHub comments. They only return findings.

            ## Step 3: Aggregate and deduplicate

            After all 5 agents complete, collect their findings. Then:
            1. Remove duplicate findings (same file + same line range + same issue)
            2. If the same pattern repeats across multiple locations, keep only the first occurrence and note "Same issue also at: file:line, file:line, ..."
            3. Compare against the existing review comments fetched in Step 1. Skip any finding already reported in a previous review thread on the same file and line.

            ## Step 4: Post inline comments

            For each remaining finding, post an inline comment using
            mcp__github_inline_comment__create_inline_comment on the specific file and line.

            When a fix is available, include a GitHub suggestion block:
            ```suggestion
            corrected code here
            ```

            Do NOT re-report issues that already exist in previous review threads.

            ## Step 5: Post closing comment

            After all inline comments are posted, post ONE comment on the PR using `gh pr comment`:
            - Briefly summarize what was reviewed and how many findings were posted
            - State: "I've provided feedback and suggestions as inline comments on the code.
              When you've addressed the feedback and believe the PR is ready for a new review,
              comment `/review` to request a new review iteration."

          claude_args: |
            --max-turns 30
            --model claude-opus-4-6
            --allowedTools "mcp__github_inline_comment__create_inline_comment"
