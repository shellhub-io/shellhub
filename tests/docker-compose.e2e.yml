version: "3.7"

services:
  ssh:
    image: ssh:test
    build:
      context: .
      dockerfile: ssh/Dockerfile
      target: production
    healthcheck:
      interval: 5s
      start_period: 10s
      retries: 20
    ports: []
  api:
    image: api:test
    build:
      context: .
      dockerfile: api/Dockerfile
      target: production
    healthcheck:
      interval: 5s
      start_period: 10s
      retries: 20
    ports: []
  gateway:
    image: gateway:test
    build:
      context: .
      dockerfile: gateway/Dockerfile
      target: production
    healthcheck:
      interval: 5s
      start_period: 10s
      retries: 20
    ports: []
  ui:
    image: ui:test
    build:
      context: .
      dockerfile: ui/Dockerfile
      target: production
    healthcheck:
      interval: 5s
      start_period: 10s
      retries: 20
    ports: []
  mongo:
    image: mongo:4.4.29
    healthcheck:
      test: 'test $$(echo "rs.initiate({ _id: ''rs'', members: [ { _id: 0, host: ''mongo:27017'' } ] }).ok || rs.status().ok" | mongo --quiet) -eq 1'
      interval: 5s
      start_period: 10s
      retries: 20
    command: ["--replSet", "rs", "--bind_ip_all"]
    ports: []
  redis:
    image: redis
    command: ["redis-server", "--appendonly", "no", "--save", "\"\""]
    ports: []

secrets:
  ssh_private_key:
    file: ./tests/ssh_private_key
  api_private_key:
    file: ./tests/api_private_key
  api_public_key:
    file: ./tests/api_public_key
